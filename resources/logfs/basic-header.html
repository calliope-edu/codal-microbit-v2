<html>
  <head>
    <meta charset="utf-8" />
    <style>
      /* Horizontal stack */
      .bb {
        display: flex;
      }
      .bb > * + * {
        margin-left: 10px;
      }
      body {
        font-family: sans-serif;
        margin: 1em;
      }
      table {
        border-collapse: collapse;
        margin-top: 1em;
        text-align: right;
      }
      tr:first-child {
        font-weight: bold;
      }
      td {
        border: 1px solid #ddd;
        padding: 8px;
        min-width: 8ch;
      }
      iframe {
        display: none;
      }
    </style>
    <link rel="stylesheet" href="https://go.calliope.cc/assets/dl/3/dl.css" />
    <script>
      // These help significantly to save bytes.
      let w = window;
      let d = document;
      let l = w.location;
      let n = null;
      let csv = "";
      let tag = d.createElement.bind(d);
      let x = "Calliope mini";
      let parseInteger = parseInt;
      // Allow external JS to override these actions if we managed to load it.
      // This script block is first so external JS can override individual functions.
      w.dl = {
        dl: () => {
          let a = tag("a");
          a.download = x+".csv";
          a.href = URL.createObjectURL(new Blob([csv], { type: "text/plain" }));
          a.click();
          a.remove();
        },
        cp: () => {
          navigator.clipboard.writeText(csv.replace(/\,/g, "\t"));
        },
        u: alert.bind(
          n,
          `Verbinde den ${x} neu und warte.`
        ),
        c: alert.bind(
          n,
          `Log wird gelÃ¶scht, wenn du den ${x} neu flashst.`
        ),
        l: () => {
          // Find the CSV text in the file system
          let p = d.querySelector("#w");
          p.a = p.appendChild;
          let raw = d.documentElement.outerHTML.split("FS_START")[2];
          // See MicroBitLog.h/cpp for the format.
          if (/^UBIT_LOG_FS_V_002/.test(raw)) {
            
            let dataStart = parseInteger(raw.substr(29, 10), 16) - 2048;
            let rawBytes = [...raw.substr(dataStart)].map(c => c.charCodeAt(0));

            // Find where the real CSV data ends
            let dataEnd = rawBytes.findIndex((_, i, arr) =>
              i + 10 < arr.length &&
              arr.slice(i, i + 10).every(b => b === 0 || b === 255)
            );

            // Hash the content and reload if it changes using an iframe to check for a different hash
            let hash = 0;
            for (let i = 0; i < raw.length; ++i) {
              hash = 31 * hash + raw.charCodeAt(i);
              hash |= 0;
            }
            let other = l.href.split("?")[1];
            if (other !== undefined) {
              // We're the iframe. Check the hash from the URL and request the parent reload if it differs.
              if (other != hash) {
                parent.postMessage("diff", "*");
              }
            } else {
              // We're the parent so add content.

              // Full log indicator
              // We also plan to add a "Log 65% full" indicator here in online mode.
              let logEnd = parseInteger(raw.substr(18, 10), 16);
              if (raw.substr(logEnd - 2048 + 1, 3) === "FUL") {
                p.a(tag("p")).innerText = "LOG VOLL";
              }

              let table = p.a(tag("table"));
              csv.split("\n").forEach(function (r) {
                let tr = table.insertRow();
                r &&
                  r.split(",").forEach(function (c) {
                    tr.insertCell().innerText = c;
                  });
              });

              // Wait for reload messages and continually reload our iframe.
              w.onmessage = function (e) {
                if (e.data == "diff") {
                  // MAYBE: Skip this if the tab is not visible.
                  l.reload();
                }
              };
              // We assume that 5s is long enough to load a file from disk.
              // We can't afford the bytes to have onload/onerror handlers.
              let iframe;
              setInterval(() => {
                iframe && iframe.remove();
                iframe = p.a(tag("iframe"));
                iframe.src = l.href + "?" + hash;
              }, 5_000);
            }
          }
        },
      };
    </script>
    <script src="https://go.calliope.cc/assets/dl/3/dl.js"></script>
    <title>Calliope mini</title>
  </head>
  <body onload="dl.l()">
    <div id="w">
      <h1>Calliope mini Datalog</h1>
      <div class="bb">
        <button onclick="dl.dl()">Herunterladen</button>
        <button onclick="dl.cp()">Kopieren</button>
        <button onclick="dl.u()">Aktualisieren&mldr;</button>
        <button onclick="dl.c()">Log leeren&mldr;</button>
      </div>
      <p id="v">Offline: kein Internet</p>
    </div>
  </body>
</html>
